# 고객 승인 시스템 구현 가이드

## 개요

이 시스템은 다음과 같은 요구사항을 구현합니다:

1. **등급 시스템**: 일반회원, 총판회원, 최고관리자
2. **매니저 필드**: 실제 관리자 ID 참조
3. **승인 워크플로우**: 최고관리자만 회원 승인/거부 가능
4. **자동 대기 상태**: 새 회원가입시 'pending' 상태로 설정

## 설치 및 설정

### 1. 데이터베이스 마이그레이션

Supabase SQL 편집기에서 다음 파일들을 순서대로 실행하세요:

1. `database-migration.sql` - 기존 데이터베이스 업데이트
2. `supabase-schema.sql` - 전체 스키마 (새 프로젝트의 경우)

### 2. 파일 변경사항

다음 파일들이 수정되었습니다:

- `src/app/customer/CustomerPageContent.tsx` - 새로운 등급 시스템과 매니저 필드 추가
- `src/app/api/users/[id]/route.ts` - 승인 워크플로우 지원
- `src/app/api/users/route.ts` - 새 회원가입시 pending 상태 설정
- `supabase-schema.sql` - 데이터베이스 스키마 업데이트

## 주요 기능

### 1. 등급 시스템

- **일반회원**: 기본 사용자
- **총판회원**: 중간 관리자 (일반회원 관리 가능)
- **최고관리자**: 모든 권한 (승인/거부 권한)

### 2. 매니저 시스템

- 고객 테이블에 "매니저" 컬럼 추가
- 실제 관리자 ID를 참조하여 고객명이 아닌 실제 매니저 정보 표시
- 편집 폼에서 매니저 선택 가능

### 3. 승인 워크플로우

#### 회원가입 프로세스
1. 사용자가 회원가입 폼 작성
2. 시스템이 자동으로 'pending' 상태로 설정
3. 최고관리자가 승인/거부 결정
4. 승인시 'active' 상태로 변경 (로그인 가능)
5. 거부시 'rejected' 상태로 변경 (로그인 불가)

#### 상태 관리
- **pending**: 승인 대기 (기본값)
- **active**: 승인됨 (로그인 가능)
- **rejected**: 거부됨 (로그인 불가)
- **suspended**: 일시정지

### 4. 권한 시스템

현재는 임시로 모든 사용자가 승인 권한을 가지도록 설정되어 있습니다.
실제 운영시에는 다음과 같이 수정해야 합니다:

```typescript
// CustomerPageContent.tsx의 handleStatusChange 함수에서
const isAdmin = true; // 이 부분을 실제 로그인 시스템과 연동
```

실제 구현시 로그인된 사용자의 등급을 확인하여:
```typescript
const currentUser = getCurrentUser(); // 실제 로그인 시스템에서 사용자 정보 가져오기
const isAdmin = currentUser?.grade === '최고관리자';
```

## 사용 방법

### 관리자 승인 프로세스

1. **새 회원가입 확인**
   - 고객관리 페이지에서 노란색 배경의 'pending' 상태 회원 확인
   - 상단에 승인 대기 알림 표시

2. **회원 정보 검토**
   - 회원 정보를 확인하여 승인 여부 결정

3. **승인/거부 처리**
   - "승인" 버튼: 회원을 활성화 (로그인 가능)
   - "거부" 버튼: 회원 가입을 거부 (로그인 불가)
   - "대기" 버튼: 다시 대기 상태로 변경

### 매니저 할당

1. 고객 정보 수정에서 "담당 매니저" 선택
2. 총판회원 또는 최고관리자만 매니저로 선택 가능
3. 매니저 정보는 테이블에서 확인 가능

## 보안 고려사항

1. **인증 시스템 연동**: 현재 임시로 구현된 권한 체크를 실제 로그인 시스템과 연동
2. **API 보안**: 승인 API에 실제 권한 검증 로직 추가
3. **로그 시스템**: 승인/거부 처리 내역 로깅

## 추가 개발 필요사항

1. **로그인 시스템 연동**
   - 현재 승인 권한은 임시 구현
   - 실제 사용자 인증과 연동 필요

2. **이메일 알림**
   - 승인/거부시 사용자에게 이메일 알림 발송

3. **대시보드 통계**
   - 승인 대기, 승인, 거부 회원 수 통계

4. **감사 로그**
   - 승인/거부 처리 내역 기록

## 문제 해결

### 데이터베이스 오류
- `database-migration.sql` 파일 재실행
- Supabase 콘솔에서 테이블 구조 확인

### API 오류
- 브라우저 개발자 도구에서 네트워크 탭 확인
- 서버 콘솔 로그 확인

### 권한 오류
- `handleStatusChange` 함수의 권한 체크 로직 확인
- 현재 사용자 정보 확인
